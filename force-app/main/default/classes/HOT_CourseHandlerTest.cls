@isTest
private class HOT_CourseHandlerTest {
    
    @testSetup
    static void setup() {
        Course__c testCourse = new Course__c(
            Name = 'Test Course',
            DescriptionFormatted__c = 'Course description for testing',
            DescriptionShort__c = 'Short test description',
            Region2__c = 'Oslo',
            Active__c = true,
            MaxNumberOfParticipants__c = 20,
            RegistrationPlaceName__c = 'Vitaminveien 100, 0485 Oslo',
            RegistrationFromDateTime__c = DateTime.now(),
            RegistrationToDateTime__c = DateTime.now().addHours(3),
            RegistrationDeadline__c = DateTime.now().addDays(-1)
        );

        insert testCourse;
    }

   @isTest
   static void testOnAfterInsert() {
    Course__c newCourse = new Course__c(
        Name = 'Trigger Inserted Course',
        DescriptionFormatted__c = 'Triggered test course',
        DescriptionShort__c = 'Short description',
        Region2__c = 'Rogaland',
        Active__c = true,
        MaxNumberOfParticipants__c = 15,
        RegistrationFromDateTime__c = DateTime.now(),
        RegistrationToDateTime__c = DateTime.now().addHours(3),
        RegistrationDeadline__c = DateTime.now().addDays(-1)
    );
    
    System.Test.startTest();
    insert newCourse;
    System.Test.stopTest();

    Course__c result = [SELECT Id, Name, OutlookCalendar__c, OutlookOfficeCalendar__c, GoogleCalendar__c FROM Course__c WHERE Id = :newCourse.Id LIMIT 1];

    System.assertNotEquals(null, result.OutlookCalendar__c, 'Outlook calendar URL should have been generated by HOT_CourseHandler.');
    System.assertNotEquals(null, result.OutlookOfficeCalendar__c, 'Outlook office calendar URL should have been generated by HOT_CourseHandler.');
    System.assertNotEquals(null, result.GoogleCalendar__c, 'Google calendar URL should have been generated by HOT_CourseHandler.');
  }

    @isTest
    static void testOnAfterUpdatedCourseUrl() {
        Course__c updatedCourse = [
            SELECT Id, Name, OutlookCalendar__c, OutlookOfficeCalendar__c, GoogleCalendar__c
            FROM Course__c
            WHERE Name = 'Test Course'
            LIMIT 1
        ];

        updatedCourse.Name = 'Updated Course';
        updatedCourse.RegistrationPlaceName__c = 'Stenersgata 500, 0050 Oslo';

        System.Test.startTest();
        update updatedCourse;
        System.Test.stopTest();

        Course__c result = [
            SELECT Name, OutlookCalendar__c, RegistrationPlaceName__c
            FROM Course__c WHERE Id = :updatedCourse.Id
        ];

        String endcodedUpdatedName = EncodingUtil.urlEncode(result.Name, 'UTF-8');
        System.assert(result.OutlookCalendar__c.contains(endcodedUpdatedName),
            'OutlookCalendar__c URL should contain the updated course endcoded Name');

        String encodedUpdatedPlace = EncodingUtil.urlEncode(result.RegistrationPlaceName__c, 'UTF-8');
        System.assert(result.OutlookCalendar__c.contains(encodedUpdatedPlace),
        'OutlookCalendar__c URL should contain the updated course place encoded RegistrationPlaceName__c.');

    }
}